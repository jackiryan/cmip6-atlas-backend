events {
    worker_connections 1024;
}

http {
    # Cache configuration
    # Store cache in /var/cache/nginx with a 100MB metadata zone
    # Max cache size: 10GB, items inactive for 365 days will be removed
    proxy_cache_path /var/cache/nginx
                     levels=1:2
                     keys_zone=tile_cache:100m
                     max_size=10g
                     inactive=365d
                     use_temp_path=off;

    upstream tileserver {
        server pg-tileserv:7800;
    }

    server {
        listen 80;

        location / {
            # Proxy to pg_tileserv
            proxy_pass http://tileserver;

            # Caching configuration
            proxy_cache tile_cache;
            proxy_cache_valid 200 365d;  # Cache successful responses for 1 year
            proxy_cache_valid 404 1m;    # Cache 404s briefly

            # Serve stale content if backend is down or slow
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

            # Only one request at a time for the same tile (prevents stampede)
            proxy_cache_lock on;
            proxy_cache_lock_timeout 60s;

            # Cache based on the full URI including query parameters
            proxy_cache_key "$scheme$proxy_host$request_uri";

            # Buffer settings for large tile responses
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 8 256k;
            proxy_busy_buffers_size 512k;
            proxy_max_temp_file_size 1024m;

            # Hide ALL CORS headers from upstream to prevent duplicates
            proxy_hide_header Access-Control-Allow-Origin;
            proxy_hide_header Access-Control-Allow-Methods;
            proxy_hide_header Access-Control-Allow-Headers;
            
            # Add CORS headers (always flag ensures they appear in cached responses too)
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range" always;

            # Add cache status header for debugging (HIT, MISS, BYPASS, etc.)
            add_header X-Cache-Status $upstream_cache_status always;

            # Client-side caching headers (browser/CDN caching)
            expires 1y;
            add_header Cache-Control "public, immutable" always;

            # Proxy settings
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }
}